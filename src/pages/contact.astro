---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Breadcrumbs from '@/components/ui/Breadcrumbs.astro';

const TURNSTILE_SITE_KEY = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY ?? '1x00000000000000000000AA';
---

<BaseLayout
  title="Contact"
  description="Contactez Agro Group ‚Äî pour toute demande commerciale, partenariat ou information."
  breadcrumbs={[{ name: 'Accueil', url: '/' }, { name: 'Contact', url: '/contact' }]}
>
  <!-- Hero -->
  <div class="bg-neutral-900 pt-32 pb-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <Breadcrumbs items={[{ label: 'Accueil', href: '/' }, { label: 'Contact' }]} light={true} />
      <h1 class="font-display text-5xl md:text-6xl font-semibold text-white mt-6">Contactez-nous</h1>
    </div>
  </div>

  <section class="section-py bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid lg:grid-cols-2 gap-16 xl:gap-24">
        <!-- Info -->
        <div class="reveal">
          <h2 class="font-display text-3xl font-semibold text-neutral-900 mb-6">
            Nous sommes √† votre √©coute
          </h2>
          <p class="text-neutral-500 leading-relaxed mb-10">
            Pour toute demande commerciale, demande de partenariat, candidature spontan√©e ou simple question, n'h√©sitez pas √† nous √©crire. Notre √©quipe vous r√©pondra dans les 48 heures ouvr√©es.
          </p>

          <div class="space-y-6">
            {[
              {
                icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>`,
                label: 'Adresse',
                value: '123 Boulevard Mohammed V\nCasablanca 20000, Maroc',
              },
              {
                icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>`,
                label: 'T√©l√©phone',
                value: '+212 5 00 00 00 00',
              },
              {
                icon: `<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>`,
                label: 'Email',
                value: 'contact@agro-group.com',
              },
            ].map((item) => (
              <div class="flex gap-4 p-5 rounded-2xl bg-neutral-50 border border-neutral-100">
                <div class="w-10 h-10 rounded-xl bg-brand-100 text-brand-700 flex items-center justify-center flex-shrink-0">
                  <Fragment set:html={item.icon} />
                </div>
                <div>
                  <p class="text-xs text-neutral-400 uppercase tracking-widest mb-1">{item.label}</p>
                  <p class="text-neutral-800 text-sm whitespace-pre-line">{item.value}</p>
                </div>
              </div>
            ))}
          </div>

          <!-- Map placeholder -->
          <div class="mt-8 rounded-2xl overflow-hidden border border-neutral-200 aspect-[16/9] bg-neutral-100 flex items-center justify-center">
            <p class="text-neutral-400 text-sm">üó∫Ô∏è Carte Google Maps ici</p>
          </div>
        </div>

        <!-- Form -->
        <div class="reveal-right">
          <form
            id="contact-form"
            class="bg-white rounded-3xl border border-neutral-100 shadow-xl p-8 md:p-10"
          >
            <h3 class="font-display text-2xl font-semibold text-neutral-900 mb-6">Envoyer un message</h3>

            <!-- Alert -->
            <div id="form-alert" class="hidden mb-6 p-4 rounded-2xl text-sm font-medium"></div>

            <div class="grid sm:grid-cols-2 gap-5 mb-5">
              <div>
                <label for="name" class="block text-sm font-medium text-neutral-700 mb-1.5">Nom complet *</label>
                <input
                  type="text"
                  id="name"
                  name="name"
                  required
                  autocomplete="name"
                  class="w-full px-4 py-3 rounded-xl border border-neutral-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-100 outline-none transition-all text-sm"
                  placeholder="Votre nom"
                />
              </div>
              <div>
                <label for="email" class="block text-sm font-medium text-neutral-700 mb-1.5">Email *</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  required
                  autocomplete="email"
                  class="w-full px-4 py-3 rounded-xl border border-neutral-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-100 outline-none transition-all text-sm"
                  placeholder="votre@email.com"
                />
              </div>
            </div>

            <div class="mb-5">
              <label for="subject" class="block text-sm font-medium text-neutral-700 mb-1.5">Sujet *</label>
              <select
                id="subject"
                name="subject"
                required
                class="w-full px-4 py-3 rounded-xl border border-neutral-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-100 outline-none transition-all text-sm bg-white"
              >
                <option value="">Choisir un sujet...</option>
                <option value="Demande commerciale">Demande commerciale</option>
                <option value="Partenariat">Partenariat</option>
                <option value="Candidature">Candidature spontan√©e</option>
                <option value="Presse">Demande presse</option>
                <option value="Autre">Autre</option>
              </select>
            </div>

            <div class="mb-6">
              <label for="message" class="block text-sm font-medium text-neutral-700 mb-1.5">Message *</label>
              <textarea
                id="message"
                name="message"
                required
                rows="5"
                class="w-full px-4 py-3 rounded-xl border border-neutral-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-100 outline-none transition-all text-sm resize-none"
                placeholder="Votre message..."
              ></textarea>
            </div>

            <!-- Turnstile widget -->
            <div class="mb-6">
              <div
                class="cf-turnstile"
                data-sitekey={TURNSTILE_SITE_KEY}
                data-theme="light"
                data-size="normal"
              ></div>
            </div>

            <button
              type="submit"
              id="submit-btn"
              class="w-full py-4 bg-brand-600 hover:bg-brand-500 text-white rounded-xl font-medium transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span id="btn-text">Envoyer le message</span>
              <svg id="btn-spinner" class="w-5 h-5 animate-spin hidden" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
              </svg>
            </button>

            <p class="text-xs text-neutral-400 text-center mt-4">
              * Champs obligatoires. Vos donn√©es sont trait√©es conform√©ment √† notre politique de confidentialit√©.
            </p>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- Turnstile script -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

  <script>
    const form = document.getElementById('contact-form') as HTMLFormElement;
    const alert = document.getElementById('form-alert')!;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const btnText = document.getElementById('btn-text')!;
    const btnSpinner = document.getElementById('btn-spinner')!;

    const showAlert = (message: string, type: 'success' | 'error') => {
      alert.textContent = message;
      alert.className = `mb-6 p-4 rounded-2xl text-sm font-medium ${
        type === 'success'
          ? 'bg-green-50 text-green-800 border border-green-200'
          : 'bg-red-50 text-red-800 border border-red-200'
      }`;
      alert.classList.remove('hidden');
    };

    const setLoading = (loading: boolean) => {
      submitBtn.disabled = loading;
      btnText.textContent = loading ? 'Envoi en cours...' : 'Envoyer le message';
      btnSpinner.classList.toggle('hidden', !loading);
    };

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      setLoading(true);
      alert.classList.add('hidden');

      const formData = new FormData(form);
      const payload = {
        name: formData.get('name'),
        email: formData.get('email'),
        subject: formData.get('subject'),
        message: formData.get('message'),
        turnstileToken: formData.get('cf-turnstile-response'),
      };

      try {
        const res = await fetch('/api/contact', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const data = await res.json() as { success: boolean; message?: string };

        if (res.ok && data.success) {
          showAlert('‚úÖ Message envoy√© avec succ√®s ! Nous vous r√©pondrons sous 48h.', 'success');
          form.reset();
          // Reset turnstile
          if ((window as any).turnstile) {
            (window as any).turnstile.reset();
          }
        } else {
          showAlert(data.message ?? 'Une erreur est survenue. Veuillez r√©essayer.', 'error');
        }
      } catch {
        showAlert('Erreur de connexion. Veuillez v√©rifier votre connexion internet.', 'error');
      } finally {
        setLoading(false);
      }
    });
  </script>
</BaseLayout>
